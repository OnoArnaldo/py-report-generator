import os
from reportgen.layout import Parser
from ..utils import Ignore

ROOT = os.path.abspath(os.path.dirname(__file__))
TEMPLATE = os.path.join(ROOT, 'templates')
DATA = os.path.join(ROOT, 'data')
ASSET = os.path.join(ROOT, 'assets')


def test_layout(canvas):
    parse = Parser(TEMPLATE, DATA, ASSET)
    report = parse('report', 'report_data.xml')

    report.process(canvas)

    canvas.save()

    assert object.__getattribute__(canvas, 'log') == [
        ['canvas/roundRect(..)',
         (28.346456692913385,
          28.346456692913385,
          453.54330708661416,
          85.03937007874015,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 7, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 7'],
        ['canvas/drawString(..)',
         (31.181102362204726, 38.181102362204726, 'Company:'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)',
         (56.69291338582677, 56.68503937007874, 'The Company'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 7, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 7'],
        ['canvas/drawString(..)',
         (31.181102362204726, 72.19685039370079, 'Address:'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)',
         (56.69291338582677, 90.70078740157481, 'The Address'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (481.8897637795275,
          28.346456692913385,
          85.03937007874026,
          85.03937007874015,
          5.0,
          1),
         {}],
        ['canvas/drawImage(..)',
         (Ignore,
          481.8897637795275,
          28.346456692913385,
          85.0393700787402,
          85.03937007874015),
         {'preserveAspectRatio': True}],
        ['canvas/roundRect(..)',
         (28.346456692913385,
          127.55905511811024,
          283.46456692913387,
          14.173228346456696,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)',
         (30.04724409448819, 139.25984251968504, 'Description'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (311.81102362204723,
          127.55905511811024,
          141.73228346456693,
          14.173228346456696,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)', (313.51181102362204, 139.25984251968504, 'Qty'), {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (453.54330708661416,
          127.55905511811024,
          113.38582677165363,
          14.173228346456696,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawRightString(..)',
         (565.228346456693, 139.25984251968504, 'Price'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (28.346456692913385,
          141.73228346456693,
          283.46456692913387,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)',
         (30.04724409448819, 153.43307086614175, 'i001: Item001'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (311.81102362204723,
          141.73228346456693,
          141.73228346456693,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)', (313.51181102362204, 153.43307086614175, '10'), {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (453.54330708661416,
          141.73228346456693,
          113.38582677165363,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawRightString(..)',
         (565.228346456693, 153.43307086614175, '1000'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (28.346456692913385,
          158.74015748031496,
          283.46456692913387,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)',
         (30.04724409448819, 170.44094488188978, 'i002: Item002'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (311.81102362204723,
          158.74015748031496,
          141.73228346456693,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)', (313.51181102362204, 170.44094488188978, '20'), {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (453.54330708661416,
          158.74015748031496,
          113.38582677165363,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawRightString(..)',
         (565.228346456693, 170.44094488188978, '2000'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (28.346456692913385,
          175.748031496063,
          283.46456692913387,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)',
         (30.04724409448819, 187.4488188976378, 'i003: Item003'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (311.81102362204723,
          175.748031496063,
          141.73228346456693,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawString(..)', (313.51181102362204, 187.4488188976378, '30'), {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (453.54330708661416,
          175.748031496063,
          113.38582677165363,
          17.00787401574803,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 10, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 10'],
        ['canvas/drawRightString(..)',
         (565.228346456693, 187.4488188976378, '3000'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setDash(..)', ((3, 1),), {}],
        ['canvas/setLineWidth(..)', (1,), {}],
        ['canvas/line(..)',
         (28.346456692913385, 206.9291338582677, 566.9291338582678, 206.9291338582677),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (28.346456692913385,
          236.2755905511811,
          538.5826771653544,
          577.2677165354334,
          5.0,
          1),
         {}],
        ['canvas/showPage(..)', (), {}],
        ['canvas/save(..)', (), {}]
    ]


def test_layout_with_namespace(canvas):
    parse = Parser(TEMPLATE, DATA, ASSET)
    report = parse('report_with_namespace', 'report_with_namespace.xml')
    report.process(canvas)

    canvas.save()

    assert object.__getattribute__(canvas, 'log') == [
        ['canvas/roundRect(..)',
         (28.346456692913385,
          28.346456692913385,
          538.5826771653544,
          141.73228346456693,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 15, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 15'],
        ['canvas/drawCentredString(..)',
         (297.6377952755906, 43.346456692913385, 'NatOp 1: Venda'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 15, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 15'],
        ['canvas/drawCentredString(..)',
         (297.6377952755906, 58.346456692913385, 'NatOp 2: Venda2'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/roundRect(..)',
         (56.69291338582677,
          198.42519685039372,
          481.88976377952764,
          586.7716535433073,
          5.0,
          1),
         {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 20, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 20'],
        ['canvas/drawString(..)',
         (56.69291338582677, 218.42519685039372, 'verProc 1: 3550308'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/saveState(..)', (), {}],
        ['canvas/setFont', ('Courier', 20, None), {}],
        ['canvas._fontname = Courier'],
        ['canvas._fontsize = 20'],
        ['canvas/drawString(..)',
         (56.69291338582677, 238.42519685039372, 'verProc 2: 3550309'),
         {}],
        ['canvas/restoreState(..)', (), {}],
        ['canvas/showPage(..)', (), {}],
        ['canvas/save(..)', (), {}]
    ]
